<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>T√¥comfome üçî | Meus Pedidos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/ico" href="/img/Logo.png">

<style>
:root{
  --laranja:#ff8c1a;
  --cinza:#f5f5f5;
  --cinza-claro:#ffffff;
  --texto:#333;
  --texto-sec:#666;
  --card:#ffffff;
  --linha:#eee;
  --sombra:rgba(0,0,0,.08);
}

/* üåô TEMA ESCURO */
html.dark-theme{
  --cinza:#1e1e1e;
  --cinza-claro:#2a2a2a;
  --texto:#f5f5f5;
  --texto-sec:#cfcfcf;
  --card:#2a2a2a;
  --linha:#3a3a3a;
  --sombra:rgba(0,0,0,.5);
}

*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Arial}
body{background:var(--cinza);color:var(--texto)}

.header{
  background:var(--laranja);
  color:#fff;
  padding:16px;
  text-align:center;
  font-weight:600;
  box-shadow:0 2px 8px var(--sombra);
}

.lista{padding:16px}

/* CARD */
.card{
  background:var(--card);
  border-radius:18px;
  padding:14px;
  margin-bottom:16px;
  box-shadow:0 4px 12px var(--sombra);
  animation:fadeUp .3s ease;
}
@keyframes fadeUp{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:none}
}

.card-top{display:flex;gap:12px}
.card h4{font-size:1em;margin-bottom:4px}
.preco{color:var(--laranja);font-weight:700}
.local{font-size:.8em;color:var(--texto-sec)}

.timeline{
  display:flex;
  gap:6px;
  margin:12px 0;
  font-size:.75em;
}
.timeline span{
  flex:1;
  padding:6px 0;
  text-align:center;
  border-radius:20px;
  background:var(--linha);
}
.timeline .ativo{background:var(--laranja);color:#fff}

.card-footer{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.status{
  padding:6px 14px;
  border-radius:20px;
  font-size:.75em;
  font-weight:600;
}
.status.aguardando{background:#fff3cd;color:#856404}
.status.preparando{background:#d1ecf1;color:#0c5460}
.status.saiu{background:#cce5ff;color:#004085}
.status.entregue{background:#d4edda;color:#155724}

.btn-sec{
  padding:8px 14px;
  border-radius:12px;
  border:1px solid var(--laranja);
  background:transparent;
  color:var(--laranja);
  font-size:.75em;
  font-weight:600;
  cursor:pointer;
}

.vazio{text-align:center;color:var(--texto-sec);margin-top:40px}

/* AVALIA√á√ÉO */
.avaliacao, .avaliacao-resumo{
  margin-top:14px;
  padding:14px;
  border-top:1px solid var(--linha);
  background:var(--cinza-claro);
  border-radius:12px;
  font-size:.85em;
}

/* ‚≠ê ESTRELAS */
.estrelas{
  display:flex;
  gap:6px;
  font-size:1.4em;
  cursor:pointer;
  margin-bottom:10px;
}
.estrelas span{color:#ccc}
.estrelas span.ativa{color:#ffc107}

/* TOAST */
.toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#333;
  color:#fff;
  padding:14px 20px;
  border-radius:14px;
  opacity:0;
  transition:.3s;
}
.toast.show{opacity:1}
.toast.success{background:#2ecc71}
.toast.error{background:#e74c3c}
</style>
</head>

<body>

<div class="header">üì¶ Meus Pedidos</div>
<div class="lista" id="listaPedidos">
  <div class="vazio">‚è≥ Carregando pedidos...</div>
</div>

<div class="toast" id="toast"></div>

<!-- üî• SCRIPT ORIGINAL ‚Äî N√ÉO ALTERADO -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, collection, query, where, onSnapshot, doc, updateDoc, getDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyD6a29L24aFSgVjmC7NFGXpdWW4g1uQsio",
  authDomain: "tocomfome-754e1.firebaseapp.com",
  projectId: "tocomfome-754e1",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const lista = document.getElementById("listaPedidos");

function ativo(status, etapa){ return status === etapa ? "ativo" : ""; }
function statusClass(status){ return status || "aguardando"; }

window.salvarAvaliacao = async (pedidoId)=>{
  const pedidoRef = doc(db,"pedidos",pedidoId);
  const card = document.getElementById(`pedido-${pedidoId}`);
  const pedido = card.querySelector(".pedido").dataset.valor;
  const motoboy = card.querySelector(".motoboy").dataset.valor;
  const tempo = card.querySelector(".tempoEntrega").value;

  await updateDoc(pedidoRef,{
    avaliacao:{pedido,motoboy,tempo,criadoEm:new Date()}
  });
  toast("Avalia√ß√£o enviada com sucesso","success");
}

function carregarPedidos(uid){
  const q = query(collection(db,"pedidos"), where("clienteId","==",uid));
  onSnapshot(q, async (snap)=>{
    lista.innerHTML="";
    if(snap.empty){
      lista.innerHTML=`<div class="vazio">üòï Nenhum pedido ainda</div>`;
      return;
    }

    for(const d of snap.docs){
      const p=d.data(), id=d.id;
      lista.innerHTML+=`
      <div class="card" id="pedido-${id}">
        <h4>${p.produtoNome}</h4>
        <div class="preco">${Number(p.valor).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</div>

        <div class="timeline">
          <span class="${ativo(p.status,'novo')}">üïí</span>
          <span class="${ativo(p.status,'preparando')}">üë®‚Äçüç≥</span>
          <span class="${ativo(p.status,'saiu')}">üõµ</span>
          <span class="${ativo(p.status,'entregue')}">‚úÖ</span>
        </div>

        <div class="card-footer">
          <div class="status ${statusClass(p.status)}">${p.status}</div>
          <button class="btn-sec" onclick="toast('Pedido reenviado','success')">üîÅ Pedir novamente</button>
        </div>

        ${p.status==="entregue"&&!p.avaliacao?`
        <div class="avaliacao">
          ‚≠ê Pedido
          <div class="estrelas pedido">${[1,2,3,4,5].map(n=>`<span onclick="avaliar(this,${n})">‚òÖ</span>`).join("")}</div>
          üõµ Motoboy
          <div class="estrelas motoboy">${[1,2,3,4,5].map(n=>`<span onclick="avaliar(this,${n})">‚òÖ</span>`).join("")}</div>
          ‚è± Tempo (min)
          <input class="tempoEntrega">
          <button onclick="salvarAvaliacao('${id}')">Enviar avalia√ß√£o</button>
        </div>`:""}
      </div>`;
    }
  });
}

onAuthStateChanged(auth, async (user)=>{
  if(!user){location.href="Cliente/login-cliente.html";return;}
  carregarPedidos(user.uid);
});
</script>

<!-- üî• MELHORIAS UX -->
<script>
const toastEl=document.getElementById("toast");
function toast(msg,tipo){
  toastEl.innerText=msg;
  toastEl.className=`toast show ${tipo}`;
  setTimeout(()=>toastEl.className="toast",3000);
}

window.avaliar=(el,nota)=>{
  const grupo=el.parentElement;
  grupo.dataset.valor=nota;
  [...grupo.children].forEach((s,i)=>{
    s.classList.toggle("ativa",i<nota);
  });
};
</script>

</body>
</html>
