<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>T√¥ com fome üçî | Produto</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/ico" href="/img/Logo.png">

<style>
:root{
--laranja:#ff8c1a;
--cinza:#f5f5f5;
--texto:#333;
--texto-sec:#555;
--card:#ffffff;
--header:#ffffff;
}
*{box-sizing:border-box;font-family:'Segoe UI', Arial;}
body{background:var(--cinza);margin:0;color:var(--texto);}
header{background:var(--header);padding:16px;font-weight:700;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.container{padding:20px}
.card{background:var(--card);border-radius:18px;padding:20px;box-shadow:0 6px 16px rgba(0,0,0,.08)}
.produto-img{width:100%;border-radius:14px;margin-bottom:15px}
.preco{color:var(--laranja);font-size:1.5em;font-weight:800}
.avaliacao{margin:15px 0;font-size:1.1em;color:#ffbb33}
.comentarios h3{margin-bottom:10px}
.comentario{margin-bottom:8px;color:var(--texto-sec)}
textarea{width:100%;border-radius:12px;padding:10px;margin-top:10px;border:1px solid #ddd}
.btn{width:100%;padding:15px;border:none;border-radius:14px;background:var(--laranja);color:#fff;font-weight:700;margin-top:10px;cursor:pointer}
.loading{text-align:center;margin-top:40px;font-weight:600}
</style>
</head>

<body>
<header>üçî Confirmar Pedido</header>

<div class="container">
<div class="loading" id="loading">Carregando produto...</div>

<div class="card" id="conteudo" style="display:none">
<img id="fotoProduto" class="produto-img">
<h2 id="nome"></h2>
<div class="preco" id="preco"></div>
<p id="descricao"></p>

<div class="avaliacao" id="avaliacao"></div>

<button class="btn" onclick="finalizarPedido()">‚úÖ Finalizar Pedido</button>

<div class="comentarios">
<h3>Coment√°rios de clientes</h3>
<div id="listaComentarios"></div>
<textarea id="opiniao" placeholder="O que achou do produto?"></textarea>
</div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, query, where, getDocs, doc, getDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyD6a29L24aFSgVjmC7NFGXpdWW4g1uQsio",
authDomain: "tocomfome-754e1.firebaseapp.com",
projectId: "tocomfome-754e1",
storageBucket: "tocomfome-754e1.appspot.com",
messagingSenderId: "997975886937",
appId: "1:997975886937:web:9bf408c35f1ed8aea13548"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let produto = null;
let clienteNome = "";

onAuthStateChanged(auth, async user=>{
if(!user){location.href="/Cadastro.html/";return;}

const snap = await getDoc(doc(db,"clientes",user.uid));
clienteNome = snap.data()?.nome || "Cliente";
carregarProduto();
});

async function carregarProduto(){
produto = JSON.parse(localStorage.getItem("produtoSelecionado"));
if(!produto) return;

document.getElementById("loading").style.display="none";
document.getElementById("conteudo").style.display="block";

document.getElementById("nome").innerText = produto.nome;
document.getElementById("preco").innerText = "R$ " + Number(produto.valor).toFixed(2);
document.getElementById("fotoProduto").src = produto.img || "img/produto.png";

const prodRef = doc(db,"comercio",produto.comercioId,"produtos",produto.id);
const prodSnap = await getDoc(prodRef);
document.getElementById("descricao").innerText =
prodSnap.exists() ? prodSnap.data().descricao : "Produto delicioso üòã";

carregarAvaliacoes();
}

async function carregarAvaliacoes(){
const q = query(
collection(db,"pedidos"),
where("produtoNome","==",produto.nome),
where("avaliacao","!=",null)
);

const snap = await getDocs(q);
let total = 0;
let qtd = 0;

const lista = document.getElementById("listaComentarios");
lista.innerHTML="";

snap.forEach(docu=>{
const d = docu.data();
total += d.avaliacao;
qtd++;

const primeiroNome = d.clienteNome.split(" ")[0];
lista.innerHTML += `<div class="comentario"><strong>${primeiroNome}:</strong> ${d.comentario || ""}</div>`;
});

document.getElementById("avaliacao").innerText =
qtd ? `‚≠ê ${ (total/qtd).toFixed(1) } (${qtd} avalia√ß√µes)` : "Sem avalia√ß√µes ainda";
}

window.finalizarPedido = async ()=>{
const user = auth.currentUser;
await addDoc(collection(db,"pedidos"),{
clienteId:user.uid,
clienteNome,
produtoNome:produto.nome,
comercioId:produto.comercioId,
valor:Number(produto.valor),
comentario:document.getElementById("opiniao").value,
avaliacao:5,
criadoEm:serverTimestamp()
});
alert("Pedido enviado!");
};
</script>
</body>
</html>
