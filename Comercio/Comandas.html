<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>T√¥ com fome üçî | Comandas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --laranja:#ff8c1a;
  --cinza:#f5f5f5;
  --card:#ffffff;
  --texto:#333;
  --texto-sec:#666;
  --linha:#eee;
}

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:'Segoe UI', Arial;
}

body{
  background:var(--cinza);
  color:var(--texto);
}

.header{
  background:var(--laranja);
  color:#fff;
  padding:16px;
  text-align:center;
  font-size:1.1em;
  font-weight:600;
}

.lista{
  padding:16px;
}

.card{
  background:var(--card);
  border-radius:16px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
}

.card h4{
  margin-bottom:4px;
}

.preco{
  color:var(--laranja);
  font-weight:700;
}

.info{
  font-size:.85em;
  color:var(--texto-sec);
  margin:6px 0;
}

.status{
  display:inline-block;
  padding:6px 12px;
  border-radius:20px;
  font-size:.75em;
  font-weight:600;
  margin-bottom:10px;
}

.status.novo{background:#fff3cd;color:#856404}
.status.preparando{background:#d1ecf1;color:#0c5460}
.status.saiu{background:#cce5ff;color:#004085}
.status.entregue{background:#d4edda;color:#155724}

.acoes{
  display:flex;
  gap:8px;
  margin-top:10px;
}

.acoes button{
  flex:1;
  padding:10px;
  border:none;
  border-radius:12px;
  font-size:.8em;
  font-weight:600;
  cursor:pointer;
}

.btn-preparar{background:#17a2b8;color:#fff}
.btn-saiu{background:#007bff;color:#fff}
.btn-entregue{background:#28a745;color:#fff}

.vazio{
  text-align:center;
  color:var(--texto-sec);
  margin-top:40px;
}
</style>
</head>

<body>

<div class="header">üì¶ Comandas</div>

<div class="lista" id="listaPedidos"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  onSnapshot,
  doc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyD6a29L24aFSgVjmC7NFGXpdWW4g1uQsio",
  authDomain: "tocomfome-754e1.firebaseapp.com",
  projectId: "tocomfome-754e1",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);


const lista = document.getElementById("listaPedidos");


/* ================== NOTIFICA√á√ÉO ================== */

let pedidosAnteriores = new Set();

/* Pedir permiss√£o */
if ("Notification" in window) {
  Notification.requestPermission();
}

/* Som */
function tocarSom() {
  const audio = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.mp3");
  audio.play();
}

/* Mostrar notifica√ß√£o */
function notificarNovoPedido(p) {

  if (Notification.permission === "granted") {

    new Notification("üçî Novo Pedido!", {
      body: `Cliente: ${p.clienteNome || "Cliente"}\nProduto: ${p.produtoNome}`,
      icon: "https://cdn-icons-png.flaticon.com/512/1046/1046784.png"
    });

  }

  tocarSom();
}


/* ================== STATUS ================== */

window.mudarStatus = async (id, status) => {

  let mensagem = "";

  if (status === "preparando") {
    mensagem = "üë®‚Äçüç≥ Deseja marcar como PREPARANDO?";
  }

  if (status === "saiu") {
    mensagem = "üõµ Deseja marcar como SAIU?";
  }

  if (status === "entregue") {
    mensagem = "‚úÖ Deseja marcar como ENTREGUE?";
  }

  if (!confirm(mensagem)) return;

  try {

    await updateDoc(doc(db, "pedidos", id), { status });

    alert("‚úÖ Atualizado!");

  } catch (e) {

    alert("‚ùå Erro: " + e.message);

  }
};


/* ================== CARREGAR PEDIDOS ================== */

function carregarPedidos(uid) {

  const q = query(
    collection(db, "pedidos"),
    where("comercioId", "==", uid)
  );

  onSnapshot(q, snap => {

    lista.innerHTML = "";

    let pedidosAtuais = new Set();
    let exibidos = 0;

    if (snap.empty) {

      lista.innerHTML = `
        <div class="vazio">
          üì≠ Nenhum pedido no momento
        </div>
      `;

      return;
    }

    snap.forEach(d => {

      const p = d.data();

      pedidosAtuais.add(d.id);

      /* Notifica√ß√£o */
      if (!pedidosAnteriores.has(d.id) && p.status === "novo") {
        notificarNovoPedido(p);
      }

      if (p.status === "entregue") return;

      exibidos++;

      lista.innerHTML += `
        <div class="card">

          <h4>${p.produtoNome}</h4>

          <div class="preco">
            R$ ${Number(p.valor).toFixed(2)}
          </div>

          <div class="info">
            üë§ Cliente: ${p.clienteNome || "-"}
          </div>

          <div class="status ${p.status || "novo"}">
            ${p.status || "novo"}
          </div>

          <div class="acoes">

            ${p.status === "novo" ? `
              <button class="btn-preparar"
                onclick="mudarStatus('${d.id}','preparando')">
                üë®‚Äçüç≥ Preparar
              </button>
            ` : ""}

            ${p.status === "preparando" ? `
              <button class="btn-saiu"
                onclick="mudarStatus('${d.id}','saiu')">
                üõµ Saiu
              </button>
            ` : ""}

            ${p.status === "saiu" ? `
              <button class="btn-entregue"
                onclick="mudarStatus('${d.id}','entregue')">
                ‚úÖ Entregue
              </button>
            ` : ""}

          </div>

        </div>
      `;

    });


    if (exibidos === 0) {

      lista.innerHTML = `
        <div class="vazio">
          üì≠ Nenhum pedido no momento
        </div>
      `;

    }

    /* Atualiza base */
    pedidosAnteriores = pedidosAtuais;

  });

}


/* ================== AUTH ================== */

onAuthStateChanged(auth, user => {

  if (!user) {
    location.href = "Comercio/login-comercio.html";
    return;
  }

  carregarPedidos(user.uid);

});

</script>

</body>
</html>
