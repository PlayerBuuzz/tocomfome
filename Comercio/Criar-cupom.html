<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>T√¥comfome üçî | Meus Cupons</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="icon" type="image/ico" href="Logo.ico">
  
<style>
:root{
  --laranja:#ff8c1a;
  --cinza:#f4f5f7;
  --branco:#ffffff;
  --texto:#333;
}

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:'Segoe UI',Arial;
}

body{
  background:var(--cinza);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:20px;
}

.box{
  background:var(--branco);
  width:100%;
  max-width:450px;
  padding:24px;
  border-radius:20px;
  box-shadow:0 10px 24px rgba(0,0,0,.12);
}

h2{
  text-align:center;
  color:var(--laranja);
  margin-bottom:15px;
}

/* Criar */
.criar{
  width:100%;
  border:none;
  background:var(--laranja);
  color:#fff;
  padding:12px;
  border-radius:12px;
  font-weight:600;
  margin-bottom:18px;
  cursor:pointer;
}

/* Lista */
.lista{
  display:flex;
  flex-direction:column;
  gap:14px;
}

/* Card */
.cupom{
  background:#fafafa;
  border:1px solid #eee;
  border-radius:14px;
  padding:14px;
}

.cupom h3{
  color:#222;
  font-size:1.1em;
}

.cupom p{
  font-size:.85em;
  color:#555;
  margin-top:4px;
}

/* Status */
.ativo{
  color:green;
  font-weight:600;
}

.inativo{
  color:red;
  font-weight:600;
}

/* A√ß√µes */
.acoes{
  display:flex;
  gap:8px;
  margin-top:10px;
}

.acoes button{
  flex:1;
  border:none;
  padding:8px;
  border-radius:8px;
  font-size:.8em;
  font-weight:600;
  cursor:pointer;
}

.btn-editar{
  background:#2563eb;
  color:#fff;
}

.btn-excluir{
  background:#dc2626;
  color:#fff;
}

/* Mensagem vazia */
.vazio{
  text-align:center;
  color:#777;
  font-size:.9em;
  padding:20px 10px;
}

/* Voltar */
.voltar{
  margin-top:20px;
  text-align:center;
  font-size:.9em;
  color:#666;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="box">

  <h2>üéüÔ∏è Meus Cupons</h2>

  <!-- BOT√ÉO CRIAR -->
  <button class="criar" onclick="criarCupom()">
    ‚ûï Criar Novo Cupom
  </button>

  <div id="lista" class="lista"></div>

  <div class="voltar" onclick="history.back()">‚Üê Voltar</div>

</div>


<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

import {
  getFirestore,
  collection,
  getDocs,
  query,
  orderBy,
  doc,
  deleteDoc,
  updateDoc,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyD6a29L24aFSgVjmC7NFGXpdWW4g1uQsio",
  authDomain: "tocomfome-754e1.firebaseapp.com",
  projectId: "tocomfome-754e1",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


/* COM√âRCIO */
const comercio = JSON.parse(localStorage.getItem("comercioSelecionado"));

if(!comercio || !comercio.comercioId){
  alert("Com√©rcio n√£o identificado.");
  location.href = "/comercio/painel.html";
}


/* CRIAR CUPOM */
window.criarCupom = async ()=>{

  const nome = prompt("Nome do cupom (ex: PROMO10):");
  if(!nome) return;

  const desconto = prompt("Desconto (%):");
  if(!desconto) return;

  const validade = prompt("Validade (AAAA-MM-DD):");
  if(!validade) return;

  const ativo = confirm("Deseja ativar agora?");

  try{

    await addDoc(
      collection(
        db,
        "comercios",
        comercio.comercioId,
        "cupons"
      ),
      {
        nome: nome.toUpperCase(),
        desconto: Number(desconto),
        validade: validade,
        ativo: ativo,
        criadoEm: serverTimestamp()
      }
    );

    alert("üéâ Cupom criado!");
    carregarCupons();

  }catch(e){

    alert("Erro ao criar.");
    console.error(e);

  }

};


/* CARREGAR CUPONS */
async function carregarCupons(){

  const lista = document.getElementById("lista");
  lista.innerHTML = "";

  try{

    const ref = collection(
      db,
      "comercios",
      comercio.comercioId,
      "cupons"
    );

    const q = query(ref, orderBy("criadoEm","desc"));

    const snapshot = await getDocs(q);

    if(snapshot.empty){

      lista.innerHTML = `
        <div class="vazio">
          üòï Nenhum cupom criado ainda
        </div>
      `;
      return;
    }

    snapshot.forEach(docu=>{

      const c = docu.data();
      const id = docu.id;

      const status = c.ativo
        ? '<span class="ativo">Ativo</span>'
        : '<span class="inativo">Inativo</span>';

      const div = document.createElement("div");
      div.className = "cupom";

      div.innerHTML = `
        <h3>${c.nome}</h3>

        <p>üí∞ Desconto: ${c.desconto}%</p>

        <p>üìÖ Validade: ${formatarData(c.validade)}</p>

        <p>Status: ${status}</p>

        <div class="acoes">

          <button class="btn-editar"
            onclick="editarCupom('${id}',
              '${c.nome}',
              ${c.desconto},
              '${c.validade}',
              ${c.ativo})">

            ‚úèÔ∏è Editar
          </button>

          <button class="btn-excluir"
            onclick="excluirCupom('${id}')">

            üóëÔ∏è Excluir
          </button>

        </div>
      `;

      lista.appendChild(div);

    });

  }catch(e){

    console.error(e);

    lista.innerHTML = `
      <div class="vazio">
        ‚ùå Erro ao carregar cupons
      </div>
    `;

  }

}


/* EXCLUIR */
window.excluirCupom = async (id)=>{

  if(!confirm("Deseja excluir este cupom?")) return;

  try{

    await deleteDoc(
      doc(
        db,
        "comercios",
        comercio.comercioId,
        "cupons",
        id
      )
    );

    alert("üóëÔ∏è Cupom exclu√≠do!");
    carregarCupons();

  }catch(e){

    alert("Erro ao excluir.");
    console.error(e);

  }

};


/* EDITAR */
window.editarCupom = async (id,nome,desconto,validade,ativo)=>{

  const novoNome = prompt("Nome:", nome);
  if(!novoNome) return;

  const novoDesconto = prompt("Desconto (%):", desconto);
  if(!novoDesconto) return;

  const novaValidade = prompt("Validade (AAAA-MM-DD):", validade);
  if(!novaValidade) return;

  const novoStatus = confirm("Deseja deixar ATIVO?\nOK = Sim | Cancelar = N√£o");

  try{

    await updateDoc(
      doc(
        db,
        "comercios",
        comercio.comercioId,
        "cupons",
        id
      ),
      {
        nome: novoNome.toUpperCase(),
        desconto: Number(novoDesconto),
        validade: novaValidade,
        ativo: novoStatus
      }
    );

    alert("‚úèÔ∏è Cupom atualizado!");
    carregarCupons();

  }catch(e){

    alert("Erro ao atualizar.");
    console.error(e);

  }

};


/* FORMATAR DATA */
function formatarData(data){

  if(!data) return "-";

  return new Date(data).toLocaleDateString("pt-BR");

}


/* START */
carregarCupons();

</script>

</body>
</html>
