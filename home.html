<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>T√¥comfome üçî | Buscar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --laranja:#ff8c1a;
  --cinza:#f9f9f9;
  --texto:#333;
  --sombra:rgba(0,0,0,.08);
}
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:'Segoe UI',Arial;
}
body{
  background:var(--cinza);
  padding-bottom:70px;
}

/* HEADER */
.header{
  background:#fff;
  padding:14px;
  display:flex;
  align-items:center;
  gap:10px;
  box-shadow:0 2px 6px var(--sombra);
}
.menu-btn img{
  width:24px;
  height:24px;
  cursor:pointer;
}
.header input{
  flex:1;
  padding:10px;
  border-radius:12px;
  border:1px solid #ddd;
}
.usuario{
  font-size:.85em;
  font-weight:600;
  color:var(--laranja);
}

/* ENDERE√áO */
.endereco{
  background:#fff;
  padding:12px 16px;
  display:flex;
  align-items:center;
  gap:8px;
  font-size:.9em;
  box-shadow:0 2px 4px var(--sombra);
  color:#777;
  margin-bottom:6px;
}
.endereco .icon{
  width:20px;
}

/* SIDEBAR */
.sidebar{
  position:fixed;
  top:0;
  left:-260px;
  width:260px;
  height:100%;
  background:#fff;
  box-shadow:2px 0 10px rgba(0,0,0,.2);
  padding:20px;
  transition:.3s;
  z-index:10;
}
.sidebar.active{ left:0; }
.sidebar h3{
  color:var(--laranja);
  margin-bottom:12px;
  display:flex;
  align-items:center;
  gap:6px;
}
.sidebar h3 img{
  width:20px;
}
.sidebar a{
  display:block;
  padding:10px 0;
  color:var(--texto);
  text-decoration:none;
  border-bottom:1px solid #eee;
}

/* OVERLAY */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  opacity:0;
  pointer-events:none;
  transition:.3s;
  z-index:9;
}
.overlay.active{
  opacity:1;
  pointer-events:auto;
}

/* CARROSSEL */
.carrossel{
  width:100%;
  overflow:hidden;
  padding:10px 0;
}
.carrossel-track{
  display:flex;
  gap:12px;
  overflow-x:auto;
  scroll-snap-type:x mandatory;
  padding:0 15px;
}
.carrossel-track img{
  width:200px;
  height:100px;
  object-fit:cover;
  border-radius:16px;
  flex-shrink:0;
  scroll-snap-align:start;
  box-shadow:0 4px 10px var(--sombra);
}

/* LISTA */
.lista{
  padding:15px;
}

/* CARD COM√âRCIO */
.card-comercio{
  background:#fff;
  border-radius:18px;
  padding:14px;
  margin-bottom:16px;
  display:flex;
  gap:14px;
  box-shadow:0 4px 12px var(--sombra);
}
.card-comercio img{
  width:90px;
  height:90px;
  border-radius:14px;
  object-fit:cover;
}
.card-comercio h4{
  font-size:1.05em;
  margin-bottom:4px;
}
.card-comercio .tipo{
  font-size:.8em;
  color:#777;
  margin-bottom:6px;
}
.card-comercio .local{
  font-size:.8em;
  color:#999;
  margin-bottom:10px;
}
.btn{
  width:100%;
  padding:10px;
  border:none;
  border-radius:12px;
  background:var(--laranja);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}

/* MENU INFERIOR */
.menu-inferior{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:#fff;
  display:flex;
  justify-content:space-around;
  padding:10px 0;
  box-shadow:0 -2px 8px var(--sombra);
}
.menu-inferior .icon{
  width:24px;
  height:24px;
  display:block;
  margin:0 auto 4px;
}
.menu-inferior div{
  flex:1;
  text-align:center;
  font-size:.8em;
  color:#333;
  cursor:pointer;
}

/* TEMA ESCURO */
body.dark-theme{
  --cinza:#1e1e1e;
  --texto:#f5f5f5;
  --sombra:rgba(0,0,0,.4);
  background:var(--cinza);
}
body.dark-theme .header,
body.dark-theme .sidebar,
body.dark-theme .endereco,
body.dark-theme .card-comercio,
body.dark-theme .menu-inferior{
  background:#2a2a2a;
}
body.dark-theme .sidebar a{
  color:#ddd;
  border-color:#444;
}
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <h3><img src="img/menu.png"> Menu</h3>

  <a href="#" onclick="filtrarTipoComercio('Hamburgueria')">Hamburgueria</a>
  <a href="#" onclick="filtrarTipoComercio('Pizzaria')">Pizzaria</a>
  <a href="#" onclick="filtrarTipoComercio('Pastelaria')">Pastelaria</a>
  <a href="#" onclick="filtrarTipoComercio('A√ßai / Sorveteria')">A√ßai / Sorveteria</a>
  <a href="#" onclick="filtrarTipoComercio('Lanchonete')">Lanchonete</a>

  <a href="#" onclick="irPerfil();fecharMenu()">Meu Perfil</a>
  <a href="#" onclick="logoff()">Sair</a>
</div>

<div class="overlay" id="overlay" onclick="fecharMenu()"></div>

<!-- HEADER -->
<div class="header">
  <div class="menu-btn" onclick="toggleMenu()">
    <img src="img/menu.png">
  </div>
  <input id="buscaInput" placeholder="Buscar restaurantes...">
  <div class="usuario">...</div>
</div>

<!-- ENDERE√áO -->
<div class="endereco">
  <img src="img/endereco.png" class="icon">
  <span>Carregando endere√ßo...</span>
</div>

<!-- CARROSSEL -->
<div class="carrossel">
  <div class="carrossel-track">
    <img src="img/banner1.jpg">
    <img src="img/banner2.jpg">
    <img src="img/banner3.jpg">
  </div>
</div>

<!-- LISTA -->
<div class="lista" id="listaProdutos"></div>

<!-- MENU INFERIOR -->
<div class="menu-inferior">
  <div onclick="irInicio()">
    <img src="img/home.png" class="icon">In√≠cio
  </div>
  <div onclick="irBusca()">
    <img src="img/buscar.png" class="icon">Buscar
  </div>
  <div onclick="irPedidos()">
    <img src="img/pedidos.png" class="icon">Pedidos
  </div>
  <div onclick="irPerfil()">
    <img src="img/perfil.png" class="icon">Perfil
  </div>
</div>

<!-- BAL√ÉO DE CHAT -->
<div id="chat-balao" style="
  position:fixed;
  bottom:80px;
  right:20px;
  background:#ff8c1a;
  color:#fff;
  padding:12px 16px;
  border-radius:50px;
  font-weight:600;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,.2);
  display:flex;
  align-items:center;
  gap:8px;
">
  <img src="img/suporte.png" style="width:20px">
  Suporte
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* üîß FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyD6a29L24aFSgVjmC7NFGXpdWW4g1uQsio",
  authDomain: "tocomfome-754e1.firebaseapp.com",
  projectId: "tocomfome-754e1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* üîß ELEMENTOS */
const lista = document.getElementById("listaProdutos");
const usuarioEl = document.querySelector(".usuario");
const enderecoEl = document.querySelector(".endereco span");
const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("overlay");
const buscaInput = document.getElementById("buscaInput");
const chatBalao = document.getElementById("chat-balao");

/* üîß ESTADO */
let comercios = [];

/* =========================
   UTIL
========================= */
const normalizar = (txt = "") =>
  txt.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

/* =========================
   MENU LATERAL
========================= */
window.toggleMenu = () => {
  sidebar.classList.toggle("active");
  overlay.classList.toggle("active");
};

window.fecharMenu = () => {
  sidebar.classList.remove("active");
  overlay.classList.remove("active");
};

/* =========================
   USU√ÅRIO / ENDERE√áO / TEMA
========================= */
onAuthStateChanged(auth, async (user) => {
  if (user) {
    const snap = await getDoc(doc(db, "clientes", user.uid));
    if (snap.exists()) {
      const dados = snap.data();

      usuarioEl.innerText = dados.nome
        ? dados.nome.split(" ")[0]
        : "Usu√°rio";

      enderecoEl.innerText = dados.endereco
        ? `${dados.endereco.bairro}, ${dados.endereco.cidade}`
        : "Endere√ßo n√£o cadastrado";

      if (dados.tema === "dark") {
        document.body.classList.add("dark-theme");
      } else {
        document.body.classList.remove("dark-theme");
      }
    }
  } else {
    usuarioEl.innerText = "Visitante";
    enderecoEl.innerText = "Endere√ßo n√£o dispon√≠vel";
  }
});

/* =========================
   LOGOFF
========================= */
window.logoff = async () => {
  await signOut(auth);
  window.location.href = "index.html";
};

/* =========================
   BARRA INFERIOR (CORRIGIDA)
========================= */
window.irInicio = () => {
  window.location.href = "home.html";
};

window.irBusca = () => {
  buscaInput?.focus();
};

window.irPedidos = () => {
  window.location.href = "Cliente/pedidos.html";
};

window.irPerfil = () => {
  window.location.href = auth.currentUser
    ? "Cliente/perfil.html"
    : "Cliente/login-cliente.html";
};

/* =========================
   CARREGAR COM√âRCIOS
========================= */
async function carregarComercios() {
  lista.innerHTML = "";
  comercios = [];

  const snap = await getDocs(collection(db, "comercios"));

  if (snap.empty) {
    lista.innerHTML =
      "<p style='padding:20px;color:#777'>Nenhum com√©rcio encontrado.</p>";
    return;
  }

  snap.forEach(docSnap => {
    const c = docSnap.data();
    if (!c.ativo) return;

    const comercio = {
      id: docSnap.id,
      nome: c.nome || "",
      tipo: c.tipoComercio || "",
      bairro: c.endereco?.bairro || "",
      cidade: c.endereco?.cidade || "",
      img: c.logoUrl || "https://images.unsplash.com/photo-1552566626-52f8b828add9"
    };

    comercios.push(comercio);
  });

  renderLista(comercios);
}

/* =========================
   RENDER LISTA
========================= */
function renderLista(listaComercios) {
  lista.innerHTML = "";

  if (!listaComercios.length) {
    lista.innerHTML =
      "<p style='padding:20px;color:#777'>Nenhum com√©rcio encontrado.</p>";
    return;
  }

  listaComercios.forEach(c => {
    lista.innerHTML += `
      <div class="card-comercio">
        <img src="${c.img}">
        <div style="flex:1">
          <h4>${c.nome}</h4>
          <div class="tipo">${c.tipo}</div>
          <div class="local">${c.bairro} ‚Ä¢ ${c.cidade}</div>
          <button class="btn" onclick="abrirComercio('${c.id}')">
            Ver card√°pio
          </button>
        </div>
      </div>
    `;
  });
}

/* =========================
   FILTRO MENU LATERAL ‚úÖ
========================= */
window.filtrarTipoComercio = (tipoMenu) => {
  const tipo = normalizar(tipoMenu);

  const filtrados = comercios.filter(c =>
    normalizar(c.tipo) === tipo
  );

  renderLista(filtrados);
  fecharMenu();
};

/* =========================
   BUSCA
========================= */
buscaInput?.addEventListener("input", () => {
  const termo = normalizar(buscaInput.value);

  const filtrados = comercios.filter(c =>
    normalizar(c.nome).includes(termo) ||
    normalizar(c.tipo).includes(termo) ||
    normalizar(c.bairro).includes(termo) ||
    normalizar(c.cidade).includes(termo)
  );

  renderLista(filtrados);
});

/* =========================
   ABRIR COM√âRCIO
========================= */
window.abrirComercio = (comercioId) => {
  localStorage.setItem(
    "comercioSelecionado",
    JSON.stringify({ comercioId })
  );
  window.location.href = "Comercio/perfil-comercio.html";
};

/* =========================
   CHAT
========================= */
chatBalao?.addEventListener("click", () => {
  window.location.href = auth.currentUser
    ? "Cliente/chat-cliente.html"
    : "Cliente/login-cliente.html";
});

/* =========================
   INIT
========================= */
carregarComercios();
</script>

</body>
</html>
