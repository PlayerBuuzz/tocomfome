<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Atendimento | T√¥ComFome</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
  --laranja:#ff8c1a;
  --cinza:#f5f5f5;
  --cinza-escuro:#ddd;
  --texto:#333;
  --sombra:rgba(0,0,0,.12);
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Arial,sans-serif;}
body{display:flex;flex-direction:column;height:100vh;background:var(--cinza);color:var(--texto);}

/* Cabe√ßalho */
.header{
  background:#fff;
  padding:12px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 6px var(--sombra);
  position:sticky;
  top:0;
  z-index:10;
  border-bottom:2px solid var(--laranja);
}
.header .logo-area{
  display:flex;
  align-items:center;
  gap:10px;
}
.header .logo-icon{
  width:28px;
  height:28px;
  background:var(--laranja);
  border-radius:6px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-weight:bold;
  font-size:1em;
}
.header h3{
  font-size:1.15em;
  font-weight:600;
  color:var(--texto);
}
.encerrar{
  font-size:.85em;
  color:#c00;
  font-weight:600;
  cursor:pointer;
  padding:6px 12px;
  border:1px solid #c00;
  border-radius:6px;
  transition:.2s;
}
.encerrar:hover{background:#c00;color:#fff;}

/* √Årea do chat */
.chat{
  flex:1;
  padding:18px;
  display:flex;
  flex-direction:column;
  gap:14px;
  overflow-y:auto;
  scroll-behavior:smooth;
  background:linear-gradient(to bottom,#fafafa,#f1f1f1);
}
.msg{
  max-width:75%;
  padding:12px 16px;
  border-radius:18px;
  font-size:.95em;
  line-height:1.5;
  box-shadow:0 2px 6px var(--sombra);
  word-wrap: break-word;
}
.cliente{
  align-self:flex-end;
  background:var(--laranja);
  color:#fff;
  border-bottom-right-radius:6px;
}
.suporte{
  align-self:flex-start;
  background:#fff;
  border:1px solid var(--cinza-escuro);
  color:var(--texto);
  border-bottom-left-radius:6px;
}
.nome{font-size:.75em;font-weight:600;margin-bottom:4px;opacity:.8;}
.data{font-size:.65em;opacity:.6;margin-top:6px;text-align:right;}

/* Rodap√© */
.footer{
  display:flex;
  gap:10px;
  padding:14px;
  background:#fff;
  box-shadow:0 -2px 6px var(--sombra);
  position:sticky;
  bottom:0;
  z-index:10;
}
.footer input{
  flex:1;
  padding:12px 16px;
  border-radius:22px;
  border:1px solid var(--cinza-escuro);
  outline:none;
  font-size:.95em;
  transition:.2s;
}
.footer input:focus{border-color:var(--laranja);box-shadow:0 0 6px rgba(255,140,26,.4);}
.footer button{
  padding:12px 22px;
  border:none;
  border-radius:22px;
  background:var(--laranja);
  color:#fff;
  font-weight:600;
  cursor:pointer;
  transition:.2s;
}
.footer button:hover{background:#e67600;}
</style>
</head>

<body>

<div class="header">
  <div class="logo-area">
    <div class="logo-icon">üçΩÔ∏è</div>
    <h3>Atendimento</h3>
  </div>
  <div class="encerrar" onclick="encerrarChat()">Encerrar Chat</div>
</div>

<div class="chat" id="chat"></div>

<div class="footer">
  <input id="msg" placeholder="Digite sua mensagem...">
  <button onclick="enviar()">Enviar</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, deleteDoc, getDocs, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyD6a29L24aFSgVjmC7NFGXpdWW4g1uQsio",
  authDomain: "tocomfome-754e1.firebaseapp.com",
  projectId: "tocomfome-754e1",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const chatEl = document.getElementById("chat");
const input = document.getElementById("msg");

let chatId = localStorage.getItem("chatSuporteId");

/* Inicializa chat com fila e verifica√ß√£o de UID */
function initChat() {
  onAuthStateChanged(auth, async (user) => {
    if(!user){
      alert("Voc√™ precisa estar logado para iniciar o atendimento.");
      return;
    }

    const chatsSnap = await getDocs(collection(db,"chats"));
    
    // Verifica se j√° existe chat do usu√°rio
    const existente = chatsSnap.docs.find(d => d.data().uid === user.uid);
    if(existente){
      chatId = existente.id;
      if(existente.data().status === "ativo"){
        ouvirMensagens();
      } else {
        chatEl.innerHTML = `<div class="msg suporte"><div class="nome">Sistema</div>
          Voc√™ j√° est√° na fila. Sua posi√ß√£o √© ${existente.data().posicao}.
          <div class="data">${new Date().toLocaleString()}</div></div>`;
      }
      localStorage.setItem("chatSuporteId", chatId);
      return;
    }

    // Se n√£o existe, cria novo
    const ativo = chatsSnap.docs.find(d => d.data().status === "ativo");
    
    if (ativo) {
      const filaCount = chatsSnap.docs.filter(d => d.data().status === "fila").length;
      const chatRef = await addDoc(collection(db,"chats"), { 
        uid: user.uid,
        criadoEm: serverTimestamp(),
        status: "fila",
        posicao: filaCount + 1
      });
      chatId = chatRef.id;
      chatEl.innerHTML = `<div class="msg suporte"><div class="nome">Sistema</div>
        Voc√™ est√° na fila de atendimento. Sua posi√ß√£o √© ${filaCount + 1}.
        <div class="data">${new Date().toLocaleString()}</div></div>`;
    } else {
      const chatRef = await addDoc(collection(db,"chats"), { 
        uid: user.uid,
        criadoEm: serverTimestamp(),
        status: "ativo"
      });
      chatId = chatRef.id;
      ouvirMensagens();
    }
    localStorage.setItem("chatSuporteId", chatId);
  });
}

/* Ouve mensagens em tempo real */
function ouvirMensagens(){
  const q = query(collection(db,"chats",chatId,"mensagens"), orderBy("criadoEm"));
  onSnapshot(q, snap=>{
    chatEl.innerHTML = "";
    snap.forEach(docu=>{
      const m = docu.data();
      const div = document.createElement("div");
      div.className = `msg ${m.autor === "cliente" ? "cliente" : "suporte"}`;
      div.innerHTML = `<div class="nome">${m.nome}</div>${m.texto}<div class="data">${m.criadoEm?.toDate().toLocaleString()}</div>`;
      chatEl.appendChild(div);
    });
    chatEl.scrollTop = chatEl.scrollHeight;
  });
}

/* Enviar mensagem */
window.enviar = async ()=>{
  if(!input.value.trim()) return;
  await addDoc(collection(db,"chats",chatId,"mensagens"),{
    texto: input.value,
    autor: "cliente",
    nome: "Voc√™",
    criadoEm: serverTimestamp()
  });
  input.value = "";
}

/* Encerrar chat */
window.encerrarChat = async ()=>{
  if(!confirm("Tem certeza que deseja encerrar o chat e apagar todas as mensagens?")) return;

  const msgs = await getDocs(collection(db,"chats",chatId,"mensagens"));
  for(const d of msgs.docs){
    await deleteDoc(d.ref);
  }
  await deleteDoc(doc(db,"chats",chatId));

  const filaSnap = await getDocs(collection(db,"chats"));
  const fila = filaSnap.docs.filter(d => d.data().status === "fila")
                .sort((a,b)=>a.data().posicao - b.data().posicao);
  
  if (fila.length > 0) {
    const filaDoc = fila[0];
    const filaData = filaDoc.data();
    await deleteDoc(doc(db,"chats",filaDoc.id));
    const novoChatRef = await addDoc(collection(db,"chats"), { 
      uid: filaData.uid,
      criadoEm: serverTimestamp(),
      status: "ativo"
    });
    chatId = novoChatRef.id;
    ouvirMensagens();
    alert("Novo cliente da fila foi atendido!");
  } else {
    localStorage.removeItem("chatSuporteId");
    chatEl.innerHTML = "";
    alert("Conversa encerrada!");
  }
};

initChat();
</script>

</body>
</html>
