<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ðŸ’¬ Suporte TÃ´ComFome</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
  --laranja:#ff8c1a;
  --cinza:#f5f5f5;
  --cinza-escuro:#ddd;
  --texto:#333;
  --sombra:rgba(0,0,0,.15);
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Arial,sans-serif;}
body{display:flex;flex-direction:column;height:100vh;background:var(--cinza);}
.header{
  background:#fff;
  padding:14px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 12px var(--sombra);
  position:sticky;
  top:0;
  z-index:10;
}
.header h3{color:var(--laranja);font-size:1.4em;font-weight:600;}
.encerrar{
  font-size:.9em;
  color:#c00;
  font-weight:600;
  cursor:pointer;
  transition:.2s;
  padding:6px 12px;
  border:1px solid #c00;
  border-radius:6px;
}
.encerrar:hover{background:#c00;color:#fff;}
.chat{
  flex:1;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow-y:auto;
  scroll-behavior:smooth;
  background:linear-gradient(to bottom,#fdfdfd,#f1f1f1);
}
.msg{
  max-width:75%;
  padding:12px 16px;
  border-radius:20px;
  font-size:.95em;
  line-height:1.4;
  box-shadow:0 2px 6px var(--sombra);
  word-wrap: break-word;
}
.cliente{
  align-self:flex-end;
  background:var(--laranja);
  color:#fff;
  border-bottom-right-radius:4px;
}
.suporte{
  align-self:flex-start;
  background:#fff;
  border:1px solid var(--cinza-escuro);
  color:var(--texto);
  border-bottom-left-radius:4px;
}
.nome{font-size:.72em;font-weight:600;margin-bottom:4px;}
.data{font-size:.65em;opacity:.6;margin-top:6px;text-align:right;}
.footer{
  display:flex;
  gap:8px;
  padding:12px;
  background:#fff;
  box-shadow:0 -2px 12px var(--sombra);
  position:sticky;
  bottom:0;
  z-index:10;
}
.footer input{
  flex:1;
  padding:12px 16px;
  border-radius:22px;
  border:1px solid var(--cinza-escuro);
  outline:none;
  font-size:.95em;
}
.footer input:focus{border-color:var(--laranja);}
.footer button{
  padding:12px 22px;
  border:none;
  border-radius:22px;
  background:var(--laranja);
  color:#fff;
  font-weight:600;
  cursor:pointer;
  transition:.2s;
}
.footer button:hover{background:#e67600;}
@media(max-width:480px){
  .msg{max-width:90%;font-size:.9em;}
  .footer input, .footer button{font-size:.9em;padding:10px;}
  .header h3{font-size:1.2em;}
}
</style>
</head>

<body>

<div class="header">
  <h3>ðŸ’¬ Suporte TÃ´ComFome</h3>
  <div class="encerrar" onclick="encerrarChat()">Encerrar Chat</div>
</div>

<div class="chat" id="chat"></div>

<div class="footer">
  <input id="msg" placeholder="Digite sua mensagem...">
  <button onclick="enviar()">Enviar</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, deleteDoc, getDocs, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyD6a29L24aFSgVjmC7NFGXpdWW4g1uQsio",
  authDomain: "tocomfome-754e1.firebaseapp.com",
  projectId: "tocomfome-754e1",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const chatEl = document.getElementById("chat");
const input = document.getElementById("msg");

let chatId = localStorage.getItem("chatSuporteId");

/* Inicializa chat: pega Ãºltimo chat existente ou cria um novo */
async function initChat() {
  const chatsSnap = await getDocs(collection(db,"chats"));
  if(!chatsSnap.empty){
    chatId = chatsSnap.docs[chatsSnap.docs.length-1].id;
  } else {
    const chatRef = await addDoc(collection(db,"chats"), { criadoEm: serverTimestamp() });
    chatId = chatRef.id;
  }
  localStorage.setItem("chatSuporteId", chatId);
  ouvirMensagens();
}

/* Ouve mensagens em tempo real */
function ouvirMensagens(){
  const q = query(collection(db,"chats",chatId,"mensagens"), orderBy("criadoEm"));
  onSnapshot(q, snap=>{
    chatEl.innerHTML = "";
    snap.forEach(docu=>{
      const m = docu.data();
      const div = document.createElement("div");
      div.className = `msg ${m.autor === "cliente" ? "cliente" : "suporte"}`;
      div.innerHTML = `<div class="nome">${m.nome}</div>${m.texto}<div class="data">${m.criadoEm?.toDate().toLocaleString()}</div>`;
      chatEl.appendChild(div);
    });
    chatEl.scrollTop = chatEl.scrollHeight;
  });
}

/* Enviar mensagem */
window.enviar = async ()=>{
  if(!input.value.trim()) return;
  await addDoc(collection(db,"chats",chatId,"mensagens"),{
    texto: input.value,
    autor: "cliente",  // Cliente sempre laranja/direita
    nome: "VocÃª",
    criadoEm: serverTimestamp()
  });
  input.value = "";
}

/* Encerrar chat */
window.encerrarChat = async ()=>{
  if(!confirm("Tem certeza que deseja encerrar o chat e apagar todas as mensagens?")) return;

  const msgs = await getDocs(collection(db,"chats",chatId,"mensagens"));
  for(const d of msgs.docs){
    await deleteDoc(d.ref);
  }
  await deleteDoc(doc(db,"chats",chatId));
  localStorage.removeItem("chatSuporteId");

  alert("Conversa encerrada!");
  chatEl.innerHTML = "";
};
initChat();
</script>

</body>
</html>
