<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>T√¥comfome üçî | Atendimento</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  
<link rel="icon" type="image/ico" href="Logo.ico">
  
<style>
:root{
  --laranja:#ff8c1a;
  --cinza:#f5f5f5;
  --cinza-escuro:#ddd;
  --texto:#333;
  --sombra:rgba(0,0,0,.1);
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Arial,sans-serif;}
body{display:flex;flex-direction:column;height:100vh;background:var(--cinza);color:var(--texto);}

/* LOGIN MODAL */
#loginModal{
  position:fixed; inset:0; display:flex; justify-content:center; align-items:center; background:rgba(0,0,0,.5); z-index:10;
}
#loginBox{
  background:#fff; padding:24px; border-radius:12px; width:90%; max-width:360px; box-shadow:0 4px 12px var(--sombra); display:flex; flex-direction:column; gap:12px;
}
#loginBox h2{color:var(--laranja); text-align:center;}
#loginBox input{padding:12px; border-radius:8px; border:1px solid #ddd; width:100%; font-size:1em;}
#loginBox button{padding:12px; border:none; border-radius:8px; background:var(--laranja); color:#fff; font-weight:600; cursor:pointer; transition:.2s;}
#loginBox button:hover{background:#e67600;}
#errorMsg{color:#c00; font-size:.85em; text-align:center; display:none;}

/* HEADER */
header{
  background:#fff;
  padding:12px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 6px var(--sombra);
  position:sticky;
  top:0;
  z-index:5;
  border-bottom:2px solid var(--laranja);
}
header .logo-area{
  display:flex;
  align-items:center;
  gap:10px;
}
header .logo-icon{
  width:28px;
  height:28px;
  background:var(--laranja);
  border-radius:6px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-weight:bold;
  font-size:1em;
}
header h3{
  font-size:1.15em;
  font-weight:600;
  color:var(--texto);
}
header button{
  font-size:.85em;
  padding:6px 12px;
  background:#c00;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
  transition:.2s;
}
header button:hover{background:#ff4d4d;}

/* CHAT */
.chat{
  flex:1;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow-y:auto;
  scroll-behavior:smooth;
  background:linear-gradient(to bottom,#fdfdfd,#f1f1f1);
}
.msg{
  max-width:75%;
  padding:12px 16px;
  border-radius:20px;
  box-shadow:0 2px 6px var(--sombra);
  word-wrap:break-word;
}
.user{align-self:flex-end; background:var(--laranja); color:#fff; border-bottom-right-radius:4px;}
.support{align-self:flex-start; background:#fff; border:1px solid var(--cinza-escuro); color:var(--texto); border-bottom-left-radius:4px;}
.nome{font-size:.7em;font-weight:600;margin-bottom:4px;}
.data{font-size:.65em;opacity:.6;margin-top:6px;text-align:right;}

/* FOOTER */
footer{
  display:flex; gap:8px; padding:12px; background:#fff; box-shadow:0 -2px 6px var(--sombra);
}
footer input{
  flex:1; padding:12px 14px; border-radius:22px; border:1px solid var(--cinza-escuro); outline:none;
}
footer input:focus{border-color:var(--laranja);}
footer button{
  padding:12px 20px; border:none; border-radius:22px; background:var(--laranja); color:#fff; font-weight:600; cursor:pointer; transition:.2s;
}
footer button:hover{background:#e67600;}
</style>
</head>

<body>

<!-- LOGIN MODAL -->
<div id="loginModal">
  <div id="loginBox">
    <h2>üë®‚Äçüíº Login Atendente</h2>
    <input id="loginUser" placeholder="Usu√°rio">
    <input id="loginPass" type="password" placeholder="Senha">
    <button onclick="fazerLogin()">Entrar</button>
    <div id="errorMsg">Usu√°rio ou senha incorretos!</div>
  </div>
</div>

<header>
  <div class="logo-area">
    <div class="logo-icon">üë®‚Äçüíº</div>
    <h3>Atendimento</h3>
  </div>
  <button onclick="encerrarChat()">Encerrar Chat</button>
</header>

<div class="chat" id="chat"></div>

<footer>
  <input type="text" id="msg" placeholder="Digite a resposta...">
  <button onclick="enviar()">Enviar</button>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyD6a29L24aFSgVjmC7NFGXpdWW4g1uQsio",
  authDomain: "tocomfome-754e1.firebaseapp.com",
  projectId: "tocomfome-754e1",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const chatEl = document.getElementById("chat");
const input = document.getElementById("msg");
let chatId = null;
/* LOGIN LOCAL */
window.fazerLogin = () => {
  const user = document.getElementById("loginUser").value.trim();
  const pass = document.getElementById("loginPass").value.trim();
  const errorMsg = document.getElementById("errorMsg");
  if(user === "Ruan" && pass === "Ruan2026"){
    document.getElementById("loginModal").style.display = "none";
    initChat();
  } else {
    errorMsg.style.display = "block";
  }
}

/* PEGAR CHAT ATIVO OU PROMOVER FILA */
async function initChat(){
  const chatsSnap = await getDocs(collection(db,"chats"));
  const ativo = chatsSnap.docs.find(d => d.data().status === "ativo");
  
  if(ativo){
    chatId = ativo.id;
    ouvirMensagens();
  } else {
    // n√£o h√° ativo, verifica fila
    const fila = chatsSnap.docs.filter(d => d.data().status === "fila")
                  .sort((a,b)=>a.data().posicao - b.data().posicao);
    if(fila.length > 0){
      // promove primeiro da fila
      const filaDoc = fila[0];
      const filaData = filaDoc.data();
      await deleteDoc(doc(db,"chats",filaDoc.id));
      const novoChatRef = await addDoc(collection(db,"chats"), { 
        uid: filaData.uid, // mant√©m o cliente
        criadoEm: serverTimestamp(),
        status: "ativo"
      });
      chatId = novoChatRef.id;
      ouvirMensagens();
      alert("Novo cliente da fila foi atendido!");
    } else {
      alert("Nenhum chat dispon√≠vel!");
    }
  }
}

/* OUVIR MENSAGENS */
function ouvirMensagens(){
  const q = query(collection(db,"chats",chatId,"mensagens"), orderBy("criadoEm"));
  onSnapshot(q, snap=>{
    chatEl.innerHTML = "";
    snap.forEach(docu=>{
      const m = docu.data();
      const div = document.createElement("div");
      div.className = `msg ${m.autor === "cliente" ? "user" : "support"}`;
      div.innerHTML = `<div class="nome">${m.nome}</div>${m.texto}<div class="data">${m.criadoEm?.toDate().toLocaleString()}</div>`;
      chatEl.appendChild(div);
    });
    chatEl.scrollTop = chatEl.scrollHeight;
  });
}

/* ENVIAR MENSAGEM */
window.enviar = async ()=>{
  if(!input.value.trim() || !chatId) return;
  await addDoc(collection(db,"chats",chatId,"mensagens"),{
    texto: input.value,
    autor: "support",
    nome: "Suporte üë®‚Äçüíº",
    criadoEm: serverTimestamp()
  });
  input.value = "";
}

/* ENCERRAR CHAT */
window.encerrarChat = async ()=>{
  if(!chatId) return;
  if(!confirm("Deseja encerrar este chat e apagar todas as mensagens?")) return;

  // Apaga mensagens do chat ativo
  const msgs = await getDocs(collection(db,"chats",chatId,"mensagens"));
  for(const d of msgs.docs){
    await deleteDoc(d.ref);
  }
  await deleteDoc(doc(db,"chats",chatId));

  // Verifica se h√° algu√©m na fila
  const filaSnap = await getDocs(collection(db,"chats"));
  const fila = filaSnap.docs.filter(d => d.data().status === "fila")
                .sort((a,b)=>a.data().posicao - b.data().posicao);
  
  if(fila.length > 0){
    const filaDoc = fila[0];
    const filaData = filaDoc.data();
    await deleteDoc(doc(db,"chats",filaDoc.id));
    const novoChatRef = await addDoc(collection(db,"chats"), { 
      uid: filaData.uid, // mant√©m o cliente
      criadoEm: serverTimestamp(),
      status: "ativo"
    });
    chatId = novoChatRef.id;
    ouvirMensagens();
    alert("Novo cliente da fila foi atendido!");
  } else {
    chatId = null;
    chatEl.innerHTML = "";
    alert("Chat encerrado!");
  }
};
</script>

</body>
</html>
