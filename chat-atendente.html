<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ðŸ’» Suporte TÃ´ComFome</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{--laranja:#ff8c1a;--cinza:#f1f1f1;--texto:#333;--fundo:#f5f5f5;--sombra:rgba(0,0,0,.1);}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Arial,sans-serif;}
body{display:flex;flex-direction:column;height:100vh;background:var(--fundo);}
#loginModal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:10;}
#loginBox{background:#fff;padding:24px;border-radius:12px;width:90%;max-width:360px;box-shadow:0 4px 12px var(--sombra);display:flex;flex-direction:column;gap:12px;}
#loginBox h2{color:var(--laranja);text-align:center;margin-bottom:12px;}
#loginBox input{padding:12px;border-radius:8px;border:1px solid #ddd;width:100%;font-size:1em;}
#loginBox button{padding:12px;border:none;border-radius:8px;background:var(--laranja);color:#fff;font-weight:600;cursor:pointer;transition:.2s;}
#loginBox button:hover{background:#e67600;}
#errorMsg{color:#c00;font-size:.85em;text-align:center;display:none;}
header{background:#fff;padding:14px 16px;display:flex;align-items:center;gap:10px;box-shadow:0 2px 8px var(--sombra);position:sticky;top:0;z-index:5;}
header span{font-size:2em;}
header strong{color:var(--laranja);font-size:1.1em;}
#chat{flex:1;padding:16px;display:flex;flex-direction:column;gap:12px;overflow-y:auto;scroll-behavior:smooth;background:linear-gradient(to bottom,#fdfdfd,#f1f1f1);}
.msg{max-width:75%;padding:12px 16px;border-radius:20px;font-size:.95em;line-height:1.3;box-shadow:0 2px 6px var(--sombra);word-wrap: break-word;}
.user{align-self:flex-end;background:var(--laranja);color:#fff;border-bottom-right-radius:4px;}
.support{align-self:flex-start;background:#fff;border:1px solid #ddd;color:var(--texto);border-bottom-left-radius:4px;}
.meta{font-size:.65em;opacity:.6;margin-top:6px;text-align:right;}
footer{display:flex;gap:8px;padding:10px;background:#fff;box-shadow:0 -2px 10px var(--sombra);position:sticky;bottom:0;z-index:5;}
footer input{flex:1;padding:12px 14px;border-radius:22px;border:1px solid #ddd;outline:none;}
footer button{padding:12px 20px;border:none;border-radius:22px;background:var(--laranja);color:#fff;font-weight:600;cursor:pointer;transition:.2s;}
footer button:hover{background:#e67600;}
#listaChats{background:#fff;border:1px solid #ddd;padding:10px;max-height:200px;overflow-y:auto;}
#listaChats button{display:block;width:100%;margin-bottom:6px;padding:8px;border:none;background:var(--laranja);color:#fff;border-radius:6px;cursor:pointer;text-align:left;}
#listaChats button:hover{background:#e67600;}
@media(max-width:480px){.msg{max-width:90%;font-size:.9em;}footer input, footer button{font-size:.9em;padding:10px;}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginModal">
  <div id="loginBox">
    <h2>ðŸ’» Login Suporte</h2>
    <input id="loginUser" placeholder="UsuÃ¡rio">
    <input id="loginPass" type="password" placeholder="Senha">
    <button onclick="fazerLogin()">Entrar</button>
    <div id="errorMsg">UsuÃ¡rio ou senha incorretos!</div>
  </div>
</div>

<header><span>ðŸ’»</span><strong>Suporte TÃ´ComFome</strong></header>

<!-- Lista de chats ativos -->
<div id="listaChats"></div>

<div id="chat"></div>

<footer>
  <input type="text" id="msg" placeholder="Digite a resposta...">
  <button onclick="enviar()">Enviar</button>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, query, where, orderBy, onSnapshot, addDoc, serverTimestamp, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyD6a29L24aFSgVjmC7NFGXpdWW4g1uQsio",
  authDomain: "tocomfome-754e1.firebaseapp.com",
  projectId: "tocomfome-754e1",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const chatEl = document.getElementById("chat");
const input = document.getElementById("msg");
const listaChatsEl = document.getElementById("listaChats");
let chatId = null;
let unsubscribeMensagens = null;

/* LOGIN LOCAL */
window.fazerLogin = () => {
  const user = document.getElementById("loginUser").value.trim();
  const pass = document.getElementById("loginPass").value.trim();
  const errorMsg = document.getElementById("errorMsg");

  if(user === "Ruan" && pass === "Ruan2026"){
    document.getElementById("loginModal").style.display = "none";
    carregarChatsAtivos();
  } else {
    errorMsg.style.display = "block";
  }
}

/* CARREGAR CHATS ATIVOS */
function carregarChatsAtivos(){
  const q = query(collection(db,"chats"), where("status","!=","encerrado"), orderBy("criadoEm"));
  onSnapshot(q, snap=>{
    listaChatsEl.innerHTML = "";
    snap.forEach(docu=>{
      const chatData = docu.data();
      const btn = document.createElement("button");
      btn.textContent = `Cliente: ${chatData.clienteId} | Status: ${chatData.status}`;
      btn.onclick = () => selecionarChat(docu.id);
      listaChatsEl.appendChild(btn);
    });
  });
}

/* SELECIONAR CHAT */
async function selecionarChat(id){
  chatId = id;
  // marcar como atendimento se ainda estiver aberto
  const chatRef = doc(db,"chats",chatId);
  const chatSnap = await chatRef.get();
  if(chatSnap.exists && chatSnap.data().status === "aberto"){
    await updateDoc(chatRef,{status:"atendimento"});
  }

  // cancelar listener antigo
  if(unsubscribeMensagens) unsubscribeMensagens();

  // ouvir mensagens deste chat
  const q = query(collection(db,"chats",chatId,"mensagens"), orderBy("criadoEm"));
  unsubscribeMensagens = onSnapshot(q, snap=>{
    chatEl.innerHTML = "";
    snap.forEach(docu=>{
      const m = docu.data();
      const div = document.createElement("div");
      div.className = `msg ${m.autor === "cliente" ? "user" : "support"}`;
      div.innerHTML = `<strong>${m.nome}</strong><br>${m.texto}<div class="meta">${m.criadoEm?.toDate().toLocaleString("pt-BR")}</div>`;
      chatEl.appendChild(div);
    });
    chatEl.scrollTop = chatEl.scrollHeight;
  });
}

/* ENVIAR MENSAGEM */
window.enviar = async () => {
  if(!input.value.trim() || !chatId) return;
  await addDoc(collection(db,"chats",chatId,"mensagens"),{
    texto: input.value,
    autor: "support",
    nome: "Suporte ðŸ’»",
    criadoEm: serverTimestamp()
  });
  input.value = "";
}
</script>

</body>
</html>
