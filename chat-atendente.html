<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ðŸ’» Atendente TÃ´ComFome</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{display:flex;flex-direction:column;height:100vh;margin:0;font-family:Arial,sans-serif;background:#f5f5f5;}
header{background:#fff;padding:14px;display:flex;align-items:center;gap:10px;box-shadow:0 2px 8px rgba(0,0,0,.1);}
.chat{flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;background:linear-gradient(to bottom,#fdfdfd,#f1f1f1);}
.msg{max-width:75%;padding:12px 16px;border-radius:20px;box-shadow:0 2px 6px rgba(0,0,0,.1);word-wrap:break-word;}
.user{align-self:flex-end;background:#ff8c1a;color:#fff;border-bottom-right-radius:4px;}
.support{align-self:flex-start;background:#fff;border:1px solid #ddd;color:#333;border-bottom-left-radius:4px;}
.nome{font-size:.7em;font-weight:600;margin-bottom:4px;}
.data{font-size:.65em;opacity:.6;margin-top:6px;text-align:right;}
footer{display:flex;gap:8px;padding:10px;background:#fff;box-shadow:0 -2px 10px rgba(0,0,0,.1);}
footer input{flex:1;padding:12px 14px;border-radius:22px;border:1px solid #ddd;outline:none;}
footer button{padding:12px 20px;border:none;border-radius:22px;background:#ff8c1a;color:#fff;font-weight:600;cursor:pointer;}
</style>
</head>
<body>

<header><strong>ðŸ’» Suporte TÃ´ComFome</strong></header>
<div class="chat" id="chat"></div>
<footer>
  <input type="text" id="msg" placeholder="Digite a resposta...">
  <button onclick="enviar()">Enviar</button>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyD6a29L24aFSgVjmC7NFGXpdWW4g1uQsio",
  authDomain: "tocomfome-754e1.firebaseapp.com",
  projectId: "tocomfome-754e1",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const chatEl = document.getElementById("chat");
const input = document.getElementById("msg");
let chatId = null;

/* PEGAR ÃšLTIMO CHAT */
async function initChat(){
  const chatsSnap = await getDocs(collection(db,"chats"));
  if(!chatsSnap.empty){
    chatId = chatsSnap.docs[chatsSnap.docs.length-1].id; // Ãºltimo chat
    ouvirMensagens();
  } else {
    alert("Nenhum chat disponÃ­vel ainda!");
  }
}

initChat();

/* OUVIR MENSAGENS */
function ouvirMensagens(){
  const q = query(collection(db,"chats",chatId,"mensagens"), orderBy("criadoEm"));
  onSnapshot(q, snap=>{
    chatEl.innerHTML = "";
    snap.forEach(docu=>{
      const m = docu.data();
      const div = document.createElement("div");
      div.className = `msg ${m.autor === "cliente" ? "user" : "support"}`;
      div.innerHTML = `<div class="nome">${m.nome}</div>${m.texto}<div class="data">${m.criadoEm?.toDate().toLocaleString()}</div>`;
      chatEl.appendChild(div);
    });
    chatEl.scrollTop = chatEl.scrollHeight;
  });
}

/* ENVIAR MENSAGEM */
window.enviar = async ()=>{
  if(!input.value.trim() || !chatId) return;
  await addDoc(collection(db,"chats",chatId,"mensagens"),{
    texto: input.value,
    autor: "support",
    nome: "Suporte ðŸ’»",
    criadoEm: serverTimestamp()
  });
  input.value = "";
}
</script>

</body>
</html>
