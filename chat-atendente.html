<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ðŸ’» Atendente TÃ´ComFome</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:'Segoe UI',Arial;
  display:flex;
  flex-direction:column;
  height:100vh;
  margin:0;
  background:#f5f5f5;
}

header{
  background:#ff8c1a;
  color:#fff;
  padding:12px;
  display:flex;
  align-items:center;
  gap:10px;
}

header img{
  width:40px;
  height:40px;
  border-radius:50%;
}

#chat{
  flex:1;
  overflow-y:auto;
  padding:10px;
}

.message{
  max-width:70%;
  padding:10px;
  margin:8px 0;
  border-radius:10px;
}

.user{
  background:#ff8c1a;
  color:#fff;
  margin-left:auto;
}

.support{
  background:#e0e0e0;
  color:#333;
  margin-right:auto;
}

.meta{
  font-size:11px;
  opacity:0.6;
  margin-top:4px;
}

footer{
  display:flex;
  padding:10px;
  background:#fff;
  gap:5px;
}

input{
  flex:1;
  padding:10px;
  border-radius:8px;
  border:1px solid #ddd;
}

button{
  background:#ff8c1a;
  border:none;
  color:#fff;
  padding:10px 15px;
  cursor:pointer;
  border-radius:8px;
}
</style>
</head>

<body>

<header>
  <img src="img/suporte.png">
  <strong>Suporte TÃ´ComFome</strong>
</header>

<div id="chat"></div>

<footer>
  <input type="text" id="msg" placeholder="Digite a resposta...">
  <button onclick="enviar()">Enviar</button>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  query,
  orderBy,
  onSnapshot,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyD6a29L24aFSgVjmC7NFGXpdWW4g1uQsio",
  authDomain: "tocomfome-754e1.firebaseapp.com",
  projectId: "tocomfome-754e1",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const chatEl = document.getElementById("chat");
const input = document.getElementById("msg");

// Para demo: pegar primeiro chat aberto
let chatId = null;

async function init(){
  const q = query(collection(db,"chats"));
  onSnapshot(q,(snap)=>{
    if(!chatId && snap.docs.length>0){
      chatId = snap.docs[0].id; // pega o primeiro chat aberto
      ouvirMensagens();
    }
  });
}

function ouvirMensagens(){
  const q = query(collection(db,"chats",chatId,"mensagens"), orderBy("criadoEm"));
  onSnapshot(q,(snap)=>{
    chatEl.innerHTML = "";
    snap.forEach(docu=>{
      const m = docu.data();
      const div = document.createElement("div");
      div.className = `message ${m.autor === "cliente" ? "user" : "support"}`;
      div.innerHTML = `
        <strong>${m.nome}</strong><br>
        ${m.texto}
        <div class="meta">${m.criadoEm?.toDate().toLocaleString("pt-BR")}</div>
      `;
      chatEl.appendChild(div);
    });
    chatEl.scrollTop = chatEl.scrollHeight;
  });
}

window.enviar = async ()=>{
  if(!input.value.trim() || !chatId) return;

  await addDoc(collection(db,"chats",chatId,"mensagens"),{
    texto: input.value,
    autor:"suporte",
    nome:"Suporte TÃ´ComFome",
    criadoEm: serverTimestamp()
  });

  input.value = "";
}

init();
</script>

</body>
</html>
